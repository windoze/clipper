import {
    Button,
    ComboBox,
    HorizontalBox,
    LineEdit,
    ListView,
    Switch,
    VerticalBox,
} from "std-widgets.slint";

// Theme colors structure
struct ThemeColors {
    background: color,
    surface: color,
    surface-hover: color,
    border: color,
    text-primary: color,
    text-secondary: color,
    text-muted: color,
    accent: color,
    dialog-overlay: color,
}

// Light theme colors
global LightTheme {
    out property <ThemeColors> colors: {
        background: #f6f7fb,
        surface: #ffffff,
        surface-hover: #f0f1f5,
        border: #d0d5dd,
        text-primary: #1f2328,
        text-secondary: #4a4a4a,
        text-muted: #6b7280,
        accent: #0066cc,
        dialog-overlay: #00000080,
    };
}

// Dark theme colors
global DarkTheme {
    out property <ThemeColors> colors: {
        background: #1a1b1e,
        surface: #2d2e32,
        surface-hover: #3a3b40,
        border: #404248,
        text-primary: #e4e4e7,
        text-secondary: #a1a1aa,
        text-muted: #71717a,
        accent: #60a5fa,
        dialog-overlay: #00000099,
    };
}

export struct ClipEntryData {
    id: string,
    content: string,
    created_at: string,
    tags: string,
    favorite: bool,
}

component SettingsDialog inherits Rectangle {
    in property <bool> dialog-visible;
    in property <ThemeColors> theme;
    in-out property <int> current-theme-index;
    in-out property <bool> use-bundled-server;
    in property <string> external-server-url;

    callback close();
    callback theme-changed(int);
    callback server-mode-changed(bool);
    callback external-url-changed(string);
    callback save-settings();

    property <[string]> theme-options: ["Light", "Dark", "Auto"];
    property <string> edited-url: external-server-url;

    if dialog-visible: Rectangle {
        width: 100%;
        height: 100%;
        background: theme.dialog-overlay;

        TouchArea {
            clicked => { close(); }
        }

        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 450px;
            height: 380px;
            background: theme.surface;
            border-radius: 12px;
            border-color: theme.border;
            border-width: 1px;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;

            TouchArea {
                // Prevent clicks from closing dialog
            }

            VerticalBox {
                padding: 24px;
                spacing: 20px;

                // Header
                HorizontalBox {
                    Text {
                        text: "Settings";
                        font-size: 20px;
                        font-weight: 600;
                        color: theme.text-primary;
                        horizontal-stretch: 1;
                    }
                    Button {
                        text: "X";
                        clicked => { close(); }
                    }
                }

                // Theme selection
                VerticalBox {
                    spacing: 8px;
                    Text {
                        text: "Theme";
                        font-size: 14px;
                        font-weight: 500;
                        color: theme.text-primary;
                    }
                    ComboBox {
                        model: theme-options;
                        current-index <=> current-theme-index;
                        selected(value) => {
                            // current-index is already updated via binding
                            theme-changed(current-theme-index);
                        }
                    }
                }

                // Server mode selection
                VerticalBox {
                    spacing: 8px;
                    Text {
                        text: "Server Mode";
                        font-size: 14px;
                        font-weight: 500;
                        color: theme.text-primary;
                    }
                    HorizontalBox {
                        spacing: 12px;
                        Switch {
                            checked: use-bundled-server;
                            toggled => {
                                server-mode-changed(self.checked);
                            }
                        }
                        Text {
                            text: use-bundled-server ? "Bundled Server" : "External Server";
                            font-size: 14px;
                            color: theme.text-secondary;
                            vertical-alignment: center;
                        }
                    }
                    Text {
                        text: use-bundled-server ? "Using built-in server (recommended)" : "Connect to external clipper-server";
                        font-size: 12px;
                        color: theme.text-muted;
                    }
                }

                // External server URL (only shown when not using bundled server)
                if !use-bundled-server: VerticalBox {
                    spacing: 8px;
                    Text {
                        text: "External Server URL";
                        font-size: 14px;
                        font-weight: 500;
                        color: theme.text-primary;
                    }
                    LineEdit {
                        text: edited-url;
                        placeholder-text: "http://localhost:3000";
                        edited(text) => {
                            edited-url = text;
                        }
                        accepted(text) => {
                            external-url-changed(text);
                        }
                    }
                }

                // Spacer
                Rectangle {
                    vertical-stretch: 1;
                }

                // Note about restart
                Text {
                    text: "Note: Server mode changes require app restart.";
                    font-size: 12px;
                    color: theme.text-muted;
                    horizontal-alignment: center;
                }

                // Save button
                HorizontalBox {
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "Save & Close";
                        clicked => {
                            if !use-bundled-server {
                                external-url-changed(edited-url);
                            }
                            save-settings();
                            close();
                        }
                    }
                }
            }
        }
    }
}

export component App inherits Window {
    title: "Clipper";
    width: 960px;
    height: 640px;

    // Theme property: 0 = light, 1 = dark, 2 = auto
    in-out property <int> theme-mode: 2;
    // Resolved dark mode (after auto detection)
    in-out property <bool> is-dark-mode: false;

    // Computed theme colors
    property <ThemeColors> theme: is-dark-mode ? DarkTheme.colors : LightTheme.colors;

    background: theme.background;

    in-out property <[ClipEntryData]> clips: [];
    in-out property <string> status-text: "";
    in-out property <bool> favorites-only: false;

    // Settings dialog state
    in-out property <bool> settings-visible: false;
    in-out property <bool> use-bundled-server: true;
    in-out property <string> external-server-url: "http://localhost:3000";

    callback search-text-changed(string);
    callback start-date-changed(string);
    callback end-date-changed(string);
    callback favorites-only-changed(bool);
    callback toggle-favorite(string);
    callback refresh-request();

    // Settings callbacks
    callback open-settings();
    callback theme-changed(int);
    callback server-mode-changed(bool);
    callback external-url-changed(string);
    callback save-settings();

    VerticalBox {
        spacing: 12px;
        HorizontalBox {
            spacing: 8px;
            LineEdit {
                placeholder-text: "Search clips";
                horizontal-stretch: 1;
                accepted => {
                    root.search-text-changed(self.text);
                }
            }

            Button {
                text: "Refresh";
                clicked => {
                    root.refresh-request();
                }
            }

            Button {
                text: "Settings";
                clicked => {
                    root.settings-visible = true;
                    root.open-settings();
                }
            }
        }

        HorizontalBox {
            spacing: 8px;
            LineEdit {
                placeholder-text: "Start date (YYYY-MM-DD)";
                width: 200px;
                accepted => {
                    root.start-date-changed(self.text);
                }
            }

            LineEdit {
                placeholder-text: "End date (YYYY-MM-DD)";
                width: 200px;
                accepted => {
                    root.end-date-changed(self.text);
                }
            }

            Switch {
                checked: root.favorites-only;
                text: "Favorites only";
                toggled => {
                    root.favorites-only = self.checked;
                    root.favorites-only-changed(self.checked);
                }
            }
        }

        Text {
            text: root.status-text;
            color: theme.text-secondary;
        }

        Rectangle {
            vertical-stretch: 1;
            border-color: theme.border;
            border-width: 1px;
            border-radius: 8px;
            clip: true;
            background: theme.surface;

            if root.clips.length == 0: Text {
                text: "No clips found";
                color: theme.text-muted;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            ListView {
                for clip in root.clips: Rectangle {
                    min-height: 110px;
                    border-width: 0px;
                    background: theme.surface;
                    VerticalBox {
                        HorizontalBox {
                            padding: 12px;
                            spacing: 12px;
                            VerticalBox {
                                spacing: 6px;
                                Text {
                                    text: clip.content;
                                    wrap: word-wrap;
                                    font-size: 16px;
                                    color: theme.text-primary;
                                }

                                Text {
                                    text: "Tags: " + (clip.tags == "" ? "-" : clip.tags);
                                    font-size: 12px;
                                    color: theme.text-muted;
                                }

                                Text {
                                    text: "Created: " + clip.created_at;
                                    font-size: 12px;
                                    color: theme.text-muted;
                                }
                            }

                            Rectangle {
                                horizontal-stretch: 1;
                                background: theme.surface;
                            }

                            VerticalBox {
                                spacing: 8px;
                                Button {
                                    text: clip.favorite ? "Favorite ON" : "Favorite OFF";
                                    clicked => {
                                        root.toggle-favorite(clip.id);
                                    }
                                }
                            }
                        }

                        Rectangle {
                            height: 1px;
                            background: theme.border;
                        }
                    }
                }
            }
        }
    }

    // Settings dialog overlay
    SettingsDialog {
        dialog-visible: root.settings-visible;
        theme: root.theme;
        current-theme-index <=> root.theme-mode;
        use-bundled-server <=> root.use-bundled-server;
        external-server-url: root.external-server-url;

        close => {
            root.settings-visible = false;
        }

        theme-changed(index) => {
            root.theme-changed(index);
        }

        server-mode-changed(bundled) => {
            root.server-mode-changed(bundled);
        }

        external-url-changed(url) => {
            root.external-server-url = url;
            root.external-url-changed(url);
        }

        save-settings => {
            root.save-settings();
        }
    }
}
