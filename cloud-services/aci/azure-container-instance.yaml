# Azure Container Instance deployment for Clipper Server
# with Azure File Share for persistent storage and ACME (Let's Encrypt) HTTPS
#
# Prerequisites:
# 1. Create an Azure Storage Account and File Share:
#    az storage account create --name <storage-account> --resource-group <rg> --location <location> --sku Standard_LRS
#    az storage share create --name clipper-data --account-name <storage-account>
#    az storage share create --name clipper-certs --account-name <storage-account>
#
# 2. Get storage account key:
#    az storage account keys list --resource-group <rg> --account-name <storage-account> --query '[0].value' -o tsv
#
# 3. Deploy:
#    az container create --resource-group <rg> --file azure-container-instance.yaml
#
# 4. Point your domain DNS to the container's public IP or FQDN

apiVersion: '2023-05-01'
location: eastus
name: clipper-server
type: Microsoft.ContainerInstance/containerGroups
properties:
  # OS type (Linux required for this container)
  osType: Linux

  # Restart policy - always restart on failure
  restartPolicy: Always

  # IP configuration with public IP and DNS label
  ipAddress:
    type: Public
    ports:
      - protocol: tcp
        port: 80    # HTTP (for ACME challenge and redirect)
      - protocol: tcp
        port: 443   # HTTPS
    # DNS name label - creates <dnsNameLabel>.<location>.azurecontainer.io
    # Replace with your desired subdomain name
    dnsNameLabel: clipper-example

  # Container definitions
  containers:
    - name: clipper-server
      properties:
        # Docker image from Docker Hub
        image: windoze/clipper-server:latest

        # Resource allocation
        resources:
          requests:
            cpu: 1.0
            memoryInGb: 1.5
          limits:
            cpu: 2.0
            memoryInGb: 2.0

        # Exposed ports
        ports:
          - port: 80
            protocol: TCP
          - port: 443
            protocol: TCP

        # Environment variables for ACME HTTPS configuration
        environmentVariables:
          # Server configuration
          - name: PORT
            value: '80'
          - name: CLIPPER_LISTEN_ADDR
            value: '0.0.0.0'

          # Storage paths (mounted Azure File Shares)
          - name: CLIPPER_DB_PATH
            value: '/data/db'
          - name: CLIPPER_STORAGE_PATH
            value: '/data/storage'

          # ACME (Let's Encrypt) configuration - ENABLE HTTPS
          - name: CLIPPER_ACME_ENABLED
            value: 'true'
          - name: CLIPPER_TLS_PORT
            value: '443'
          - name: CLIPPER_TLS_REDIRECT
            value: 'true'
          # IMPORTANT: Replace with your actual domain
          # Use the Azure-generated FQDN: <dnsNameLabel>.<location>.azurecontainer.io
          # Or your custom domain pointing to this container
          - name: CLIPPER_ACME_DOMAIN
            value: 'clipper-example.eastus.azurecontainer.io'
          # IMPORTANT: Replace with your email for Let's Encrypt notifications
          - name: CLIPPER_ACME_EMAIL
            value: 'admin@example.com'
          # Set to 'true' for testing to avoid rate limits, 'false' for production
          - name: CLIPPER_ACME_STAGING
            value: 'false'
          # Certificate cache directory
          - name: CLIPPER_CERTS_DIR
            value: '/certs'

          # Authentication (optional but recommended for public deployment)
          # Uncomment and set a secure token:
          # - name: CLIPPER_BEARER_TOKEN
          #   secureValue: 'your-secure-token-here'

          # Auto-cleanup configuration (optional)
          - name: CLIPPER_CLEANUP_ENABLED
            value: 'true'
          - name: CLIPPER_CLEANUP_RETENTION_DAYS
            value: '30'
          - name: CLIPPER_CLEANUP_INTERVAL_HOURS
            value: '24'

          # Logging level
          - name: RUST_LOG
            value: 'clipper_server=info,tower_http=info'

        # Volume mounts
        volumeMounts:
          # Data volume for database and file storage
          - name: data-volume
            mountPath: /data
          # Certificates volume for ACME certificate cache
          - name: certs-volume
            mountPath: /certs

  # Volume definitions - Azure File Shares
  volumes:
    # Main data volume (database + uploaded files)
    - name: data-volume
      azureFile:
        shareName: clipper-data
        # Replace with your storage account name
        storageAccountName: '<your-storage-account-name>'
        # Replace with your storage account key (use secureValue for security)
        storageAccountKey: '<your-storage-account-key>'
        readOnly: false

    # Certificates volume (ACME certificate cache)
    - name: certs-volume
      azureFile:
        shareName: clipper-certs
        # Replace with your storage account name
        storageAccountName: '<your-storage-account-name>'
        # Replace with your storage account key
        storageAccountKey: '<your-storage-account-key>'
        readOnly: false

tags:
  app: clipper
  environment: production
